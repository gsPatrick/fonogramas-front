{% extends "usuario/base_usuario.html" %}

{% block page_title %}Editar: {{ fonograma.titulo }}{% endblock %}

{% block usuario_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- SEÇÃO 1 - IDENTIFICAÇÃO -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-music-note-beamed me-2"></i>1. Identificação do Fonograma
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">ISRC</label>
                            <input type="text" class="form-control bg-light" name="isrc" value="{{ fonograma.isrc }}"
                                readonly>
                            <div class="form-text">O ISRC não pode ser alterado</div>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Título do Fonograma *</label>
                            <input type="text" class="form-control" name="titulo" required
                                value="{{ fonograma.titulo }}">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Versão</label>
                            <select class="form-select" name="versao">
                                <option value="">Selecione...</option>
                                <option value="original" {{ 'selected' if fonograma.versao=='original' }}>Original
                                </option>
                                <option value="remix" {{ 'selected' if fonograma.versao=='remix' }}>Remix</option>
                                <option value="ao_vivo" {{ 'selected' if fonograma.versao=='ao_vivo' }}>Ao Vivo</option>
                                <option value="instrumental" {{ 'selected' if fonograma.versao=='instrumental' }}>
                                    Instrumental</option>
                                <option value="acoustic" {{ 'selected' if fonograma.versao=='acoustic' }}>Acoustic
                                </option>
                                <option value="radio_edit" {{ 'selected' if fonograma.versao=='radio_edit' }}>Radio Edit
                                </option>
                                <option value="cover" {{ 'selected' if fonograma.versao=='cover' }}>Cover</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Duração *</label>
                            <input type="text" class="form-control" name="duracao" placeholder="03:45" required
                                value="{{ fonograma.duracao }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ano Gravação</label>
                            <input type="number" class="form-control" name="ano_grav" min="1900" max="2100"
                                value="{{ fonograma.ano_grav }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ano Lançamento</label>
                            <input type="number" class="form-control" name="ano_lanc" min="1900" max="2100"
                                value="{{ fonograma.ano_lanc }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Idioma</label>
                            <select class="form-select" name="idioma">
                                <option value="">Selecione...</option>
                                <option value="PT" {{ 'selected' if fonograma.idioma=='PT' }}>Português</option>
                                <option value="EN" {{ 'selected' if fonograma.idioma=='EN' }}>Inglês</option>
                                <option value="ES" {{ 'selected' if fonograma.idioma=='ES' }}>Espanhol</option>
                                <option value="FR" {{ 'selected' if fonograma.idioma=='FR' }}>Francês</option>
                                <option value="IT" {{ 'selected' if fonograma.idioma=='IT' }}>Italiano</option>
                                <option value="DE" {{ 'selected' if fonograma.idioma=='DE' }}>Alemão</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Gênero *</label>
                            <select class="form-select" name="genero" required>
                                <option value="">Selecione...</option>
                                <option value="Sertanejo" {{ 'selected' if fonograma.genero=='Sertanejo' }}>Sertanejo
                                </option>
                                <option value="Pop" {{ 'selected' if fonograma.genero=='Pop' }}>Pop</option>
                                <option value="Rock" {{ 'selected' if fonograma.genero=='Rock' }}>Rock</option>
                                <option value="MPB" {{ 'selected' if fonograma.genero=='MPB' }}>MPB</option>
                                <option value="Funk" {{ 'selected' if fonograma.genero=='Funk' }}>Funk</option>
                                <option value="Pagode" {{ 'selected' if fonograma.genero=='Pagode' }}>Pagode</option>
                                <option value="Forró" {{ 'selected' if fonograma.genero=='Forró' }}>Forró</option>
                                <option value="Axé" {{ 'selected' if fonograma.genero=='Axé' }}>Axé</option>
                                <option value="Gospel" {{ 'selected' if fonograma.genero=='Gospel' }}>Gospel</option>
                                <option value="Eletrônica" {{ 'selected' if fonograma.genero=='Eletrônica' }}>Eletrônica
                                </option>
                                <option value="Hip-Hop" {{ 'selected' if fonograma.genero=='Hip-Hop' }}>Hip-Hop</option>
                                <option value="Jazz" {{ 'selected' if fonograma.genero=='Jazz' }}>Jazz</option>
                                <option value="Blues" {{ 'selected' if fonograma.genero=='Blues' }}>Blues</option>
                                <option value="Clássico" {{ 'selected' if fonograma.genero=='Clássico' }}>Clássico
                                </option>
                                <option value="Reggae" {{ 'selected' if fonograma.genero=='Reggae' }}>Reggae</option>
                                <option value="Bossa Nova" {{ 'selected' if fonograma.genero=='Bossa Nova' }}>Bossa Nova
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Código Interno</label>
                            <input type="text" class="form-control" name="cod_interno"
                                value="{{ fonograma.cod_interno }}">
                        </div>

                        <!-- Novos Campos Identificação -->
                        <div class="col-md-6">
                            <label class="form-label">Nacional/Internacional</label>
                            <select class="form-select" name="flag_nacional" id="flag_nacional_edit"
                                onchange="toggleSubdivisaoEdit()">
                                <option value="">Selecione...</option>
                                <option value="NACIONAL" {{ 'selected' if fonograma.flag_nacional=='NACIONAL' }}>
                                    Nacional</option>
                                <option value="INTERNACIONAL" {{ 'selected' if fonograma.flag_nacional=='INTERNACIONAL'
                                    }}>Internacional</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Classificação Trilha</label>
                            <input type="text" class="form-control" name="classificacao_trilha"
                                value="{{ fonograma.classificacao_trilha }}" placeholder="Ex: Original, Adaptada...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 2 - OBRA MUSICAL -->
            <div class="card mb-4">
                <div class="card-header" style="background: var(--sbacem-roxo-claro); color: white;">
                    <i class="bi bi-file-music me-2"></i>2. Obra Musical
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Título da Obra *</label>
                            <input type="text" class="form-control" name="titulo_obra" required
                                value="{{ fonograma.titulo_obra }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Código da Obra</label>
                            <input type="text" class="form-control" name="cod_obra" value="{{ fonograma.cod_obra }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Nacional/Internacional</label>
                            <select class="form-select" name="flag_nacional" id="flag_nacional_edit"
                                onchange="toggleSubdivisaoEdit()">
                                <option value="">Selecione...</option>
                                <option value="NACIONAL" {{ 'selected' if fonograma.flag_nacional=='NACIONAL' }}>
                                    Nacional</option>
                                <option value="INTERNACIONAL" {{ 'selected' if fonograma.flag_nacional=='INTERNACIONAL'
                                    }}>Internacional</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Arranjo</label>
                            <select class="form-select" name="tipo_arranjo">
                                <option value="">Selecione...</option>
                                <option value="ORIGINAL" {{ 'selected' if fonograma.tipo_arranjo=='ORIGINAL' }}>
                                    Original
                                </option>
                                <option value="ARRANJO" {{ 'selected' if fonograma.tipo_arranjo=='ARRANJO' }}>
                                    Arranjo
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="publicacao_simultanea"
                                    id="publicacao_simultanea_edit" value="1" {{ 'checked' if
                                    fonograma.publicacao_simultanea }}>
                                <label class="form-check-label" for="publicacao_simultanea_edit">
                                    Publicação Simultânea
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6" id="div_subdivisao_edit" style="display: none;">
                            <label class="form-label">Subdivisão (Estrangeiro)</label>
                            <input type="text" class="form-control" name="subdivisao_estrangeiro"
                                placeholder="Subdivisão para fonogramas estrangeiros"
                                value="{{ fonograma.subdivisao_estrangeiro }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 3 - TITULARES E PARTICIPANTES -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-people me-2"></i>3. Titulares e Participantes
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="participantesTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="autores-tab" data-bs-toggle="tab"
                                data-bs-target="#autores" type="button" role="tab">Autores</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="interpretes-tab" data-bs-toggle="tab"
                                data-bs-target="#interpretes" type="button" role="tab">Intérpretes</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="musicos-tab" data-bs-toggle="tab" data-bs-target="#musicos"
                                type="button" role="tab">Músicos</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="participantesTabContent">

                        <!-- AUTORES -->
                        <div class="tab-pane show active" id="autores" role="tabpanel">
                            <div id="container-autores">
                                {% for autor in fonograma.autores_list %}
                                <div class="row g-2 mb-2 border-bottom pb-2">
                                    <div class="col-md-3">
                                        <label class="form-label small">Nome Completo</label>
                                        <input type="text" class="form-control form-control-sm" name="autores_nome[]"
                                            required value="{{ autor.nome }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">CPF</label>
                                        <input type="text" class="form-control form-control-sm" name="autores_cpf[]"
                                            value="{{ autor.cpf }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Função</label>
                                        <select class="form-select form-select-sm" name="autores_funcao[]">
                                            <option value="AUTOR" {{ 'selected' if autor.funcao=='AUTOR' }}>Autor
                                            </option>
                                            <option value="COMPOSITOR" {{ 'selected' if autor.funcao=='COMPOSITOR' }}>
                                                Compositor</option>
                                            <option value="VERSIONISTA" {{ 'selected' if autor.funcao=='VERSIONISTA' }}>
                                                Versionista</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">%</label>
                                        <input type="text" class="form-control form-control-sm"
                                            name="autores_percentual[]" value="{{ autor.percentual }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">CAE/IPI</label>
                                        <input type="text" class="form-control form-control-sm" name="autores_cae[]"
                                            value="{{ autor.cae_ipi or '' }}">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small"></label>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                            onclick="this.parentElement.parentElement.remove()"><i
                                                class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                onclick="adicionarAutor()">
                                <i class="bi bi-plus-circle me-1"></i>Adicionar Autor
                            </button>
                        </div>

                        <!-- INTÉRPRETES -->
                        <div class="tab-pane" id="interpretes" role="tabpanel">
                            <div id="container-interpretes">
                                {% for interprete in fonograma.interpretes_list %}
                                <div class="row g-2 mb-2 border-bottom pb-2">
                                    <div class="col-md-3">
                                        <label class="form-label small">Nome Artístico</label>
                                        <input type="text" class="form-control form-control-sm"
                                            name="interpretes_nome[]" required value="{{ interprete.nome }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">CPF/CNPJ</label>
                                        <input type="text" class="form-control form-control-sm" name="interpretes_doc[]"
                                            value="{{ interprete.doc }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Categoria</label>
                                        <select class="form-select form-select-sm" name="interpretes_categoria[]">
                                            <option value="INTERPRETE" {{ 'selected' if
                                                interprete.categoria=='INTERPRETE' }}>Intérprete</option>
                                            <option value="MUSICO" {{ 'selected' if interprete.categoria=='MUSICO' }}>
                                                Músico</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">%</label>
                                        <input type="text" class="form-control form-control-sm"
                                            name="interpretes_percentual[]" value="{{ interprete.percentual }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Associação</label>
                                        <select class="form-select form-select-sm" name="interpretes_assoc[]">
                                            <option value="">Selecione...</option>
                                            <option value="ABRAMUS" {{ 'selected' if interprete.associacao=='ABRAMUS'
                                                }}>ABRAMUS</option>
                                            <option value="UBC" {{ 'selected' if interprete.associacao=='UBC' }}>UBC
                                            </option>
                                            <option value="AMAR" {{ 'selected' if interprete.associacao=='AMAR' }}>
                                                AMAR
                                            </option>
                                            <option value="SBACEM" {{ 'selected' if interprete.associacao=='SBACEM' }}>
                                                SBACEM</option>
                                            <option value="SICAM" {{ 'selected' if interprete.associacao=='SICAM' }}>
                                                SICAM</option>
                                            <option value="SOCINPRO" {{ 'selected' if interprete.associacao=='SOCINPRO'
                                                }}>SOCINPRO</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small"></label>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                            onclick="this.parentElement.parentElement.remove()"><i
                                                class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                onclick="adicionarInterprete()">
                                <i class="bi bi-plus-circle me-1"></i>Adicionar Intérprete
                            </button>
                        </div>

                        <!-- MÚSICOS -->
                        <div class="tab-pane" id="musicos" role="tabpanel">
                            <div id="container-musicos">
                                {% for musico in fonograma.musicos_list %}
                                <div class="row g-2 mb-2 border-bottom pb-2">
                                    <div class="col-md-3">
                                        <label class="form-label small">Nome</label>
                                        <input type="text" class="form-control form-control-sm" name="musicos_nome[]"
                                            required value="{{ musico.nome }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">CPF</label>
                                        <input type="text" class="form-control form-control-sm" name="musicos_cpf[]"
                                            value="{{ musico.cpf }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Instrumento</label>
                                        <input type="text" class="form-control form-control-sm"
                                            name="musicos_instrumento[]" value="{{ musico.instrumento }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Tipo</label>
                                        <select class="form-select form-select-sm" name="musicos_tipo[]">
                                            <option value="ACOMPANHANTE" {{ 'selected' if musico.tipo=='ACOMPANHANTE'
                                                }}>Acompanhante</option>
                                            <option value="SOLISTA" {{ 'selected' if musico.tipo=='SOLISTA' }}>
                                                Solista
                                            </option>
                                            <option value="ARRANJADOR" {{ 'selected' if musico.tipo=='ARRANJADOR' }}>
                                                Arranjador</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small"></label>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                            onclick="this.parentElement.parentElement.remove()"><i
                                                class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                onclick="adicionarMusico()">
                                <i class="bi bi-plus-circle me-1"></i>Adicionar Músico
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 4 - PRODUTOR -->
            <div class="card mb-4">
                <div class="card-header" style="background: #2d5016; color: white;">
                    <i class="bi bi-person-badge me-2"></i>3. Produtor Fonográfico
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome do Produtor *</label>
                            <input type="text" class="form-control" name="prod_nome" required
                                value="{{ fonograma.prod_nome }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">CPF/CNPJ *</label>
                            <input type="text" class="form-control" name="prod_doc" required
                                value="{{ fonograma.prod_doc }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Percentual *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="prod_perc" required step="0.01" min="0"
                                    max="100" value="{{ fonograma.prod_perc }}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Nome Fantasia</label>
                            <input type="text" class="form-control" name="prod_fantasia"
                                value="{{ fonograma.prod_fantasia }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Associação</label>
                            <select class="form-select" name="prod_assoc">
                                <option value="">Selecione...</option>
                                <option value="ABRAMUS" {{ 'selected' if fonograma.prod_assoc=='ABRAMUS' }}>ABRAMUS
                                </option>
                                <option value="UBC" {{ 'selected' if fonograma.prod_assoc=='UBC' }}>UBC</option>
                                <option value="AMAR" {{ 'selected' if fonograma.prod_assoc=='AMAR' }}>AMAR</option>
                                <option value="SBACEM" {{ 'selected' if fonograma.prod_assoc=='SBACEM' }}>SBACEM
                                </option>
                                <option value="SICAM" {{ 'selected' if fonograma.prod_assoc=='SICAM' }}>SICAM
                                </option>
                                <option value="SOCINPRO" {{ 'selected' if fonograma.prod_assoc=='SOCINPRO' }}>
                                    SOCINPRO
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Início</label>
                            <input type="text" class="form-control" name="prod_data_ini" placeholder="dd/mm/yyyy"
                                value="{{ fonograma.prod_data_ini }}">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Endereço</label>
                            <input type="text" class="form-control" name="prod_endereco"
                                value="{{ fonograma.prod_endereco }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 5 - LANÇAMENTO -->
            <div class="card mb-4">
                <div class="card-header" style="background: #0d6efd; color: white;">
                    <i class="bi bi-disc me-2"></i>4. Lançamento
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Lançamento</label>
                            <select class="form-select" name="tipo_lanc">
                                <option value="">Selecione...</option>
                                <option value="ALBUM" {{ 'selected' if fonograma.tipo_lanc=='ALBUM' }}>Álbum
                                </option>
                                <option value="SINGLE" {{ 'selected' if fonograma.tipo_lanc=='SINGLE' }}>Single
                                </option>
                                <option value="EP" {{ 'selected' if fonograma.tipo_lanc=='EP' }}>EP</option>
                                <option value="COMPILACAO" {{ 'selected' if fonograma.tipo_lanc=='COMPILACAO' }}>
                                    Compilação</option>
                                <option value="TRILHA_SONORA" {{ 'selected' if fonograma.tipo_lanc=='TRILHA_SONORA' }}>
                                    Trilha Sonora</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Álbum</label>
                            <input type="text" class="form-control" name="album" value="{{ fonograma.album }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Faixa</label>
                            <input type="number" class="form-control" name="faixa" min="1"
                                value="{{ fonograma.faixa }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Formato</label>
                            <select class="form-select" name="formato">
                                <option value="">Selecione...</option>
                                <option value="DIGITAL" {{ 'selected' if fonograma.formato=='DIGITAL' }}>Digital
                                </option>
                                <option value="FISICO" {{ 'selected' if fonograma.formato=='FISICO' }}>Físico
                                </option>
                                <option value="AMBOS" {{ 'selected' if fonograma.formato=='AMBOS' }}>Ambos</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Selo</label>
                            <input type="text" class="form-control" name="selo" value="{{ fonograma.selo }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">País Lançamento</label>
                            <input type="text" class="form-control" name="pais" value="{{ fonograma.pais }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">País de Origem</label>
                            <input type="text" class="form-control" name="pais_origem"
                                value="{{ fonograma.pais_origem }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data de Lançamento</label>
                            <input type="text" class="form-control" name="data_lanc" placeholder="dd/mm/yyyy"
                                value="{{ fonograma.data_lanc }}">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Outros Países (Separar por vírgula se houver mais de
                                um)</label>
                            <textarea class="form-control" name="paises_adicionais"
                                rows="2">{{ fonograma.paises_adicionais }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 6 - ADMINISTRATIVO -->
            <div class="card mb-4">
                <div class="card-header" style="background: #6c757d; color: white;">
                    <i class="bi bi-gear me-2"></i>5. Administrativo
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Situação</label>
                            <select class="form-select" name="situacao">
                                <option value="ATIVO" {{ 'selected' if fonograma.situacao=='ATIVO' }}>Ativo</option>
                                <option value="PENDENTE" {{ 'selected' if fonograma.situacao=='PENDENTE' }}>Pendente
                                </option>
                                <option value="EM_DISPUTA" {{ 'selected' if fonograma.situacao=='EM_DISPUTA' }}>Em
                                    Disputa</option>
                                <option value="INATIVO" {{ 'selected' if fonograma.situacao=='INATIVO' }}>Inativo
                                </option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Observações Jurídicas</label>
                            <textarea class="form-control" name="obs_juridicas"
                                rows="2">{{ fonograma.obs_juridicas }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 8 - DISTRIBUIÇÃO -->
            <div class="card mb-4">
                <div class="card-header" style="background: #dc3545; color: white;">
                    <i class="bi bi-globe me-2"></i>6. Distribuição
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Território</label>
                            <select class="form-select" name="territorio">
                                <option value="">Selecione...</option>
                                <option value="BRASIL" {{ 'selected' if fonograma.territorio=='BRASIL' }}>Brasil
                                </option>
                                <option value="INTERNACIONAL" {{ 'selected' if fonograma.territorio=='INTERNACIONAL' }}>
                                    Internacional</option>
                                <option value="AMBOS" {{ 'selected' if fonograma.territorio=='AMBOS' }}>Ambos
                                </option>
                                <option value="AMERICA_LATINA" {{ 'selected' if fonograma.territorio=='AMERICA_LATINA'
                                    }}>América Latina</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tipos de Execução</label>
                            <select class="form-select" name="tipos_exec">
                                <option value="">Selecione...</option>
                                <option value="TODOS" {{ 'selected' if fonograma.tipos_exec=='TODOS' }}>Todos
                                </option>
                                <option value="RADIO" {{ 'selected' if fonograma.tipos_exec=='RADIO' }}>Rádio
                                </option>
                                <option value="TV" {{ 'selected' if fonograma.tipos_exec=='TV' }}>TV</option>
                                <option value="STREAMING" {{ 'selected' if fonograma.tipos_exec=='STREAMING' }}>
                                    Streaming</option>
                                <option value="SHOWS" {{ 'selected' if fonograma.tipos_exec=='SHOWS' }}>Shows
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Prioridade</label>
                            <select class="form-select" name="prioridade">
                                <option value="">Selecione...</option>
                                <option value="NORMAL" {{ 'selected' if fonograma.prioridade=='NORMAL' }}>Normal
                                </option>
                                <option value="ALTA" {{ 'selected' if fonograma.prioridade=='ALTA' }}>Alta</option>
                                <option value="URGENTE" {{ 'selected' if fonograma.prioridade=='URGENTE' }}>Urgente
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INFO STATUS ECAD -->
            {% if fonograma.status_ecad and fonograma.status_ecad != 'PENDENTE' %}
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Status ECAD:</strong> {{ fonograma.status_ecad }}
                {% if fonograma.data_ultimo_envio %}
                — Último envio em {{ fonograma.data_ultimo_envio.strftime('%d/%m/%Y') }}
                {% endif %}
            </div>
            {% endif %}

            <!-- AÇÕES -->
            <div class="d-flex justify-content-between mb-5">
                <a href="{{ url_for('usuario.detalhes_fonograma', fonograma_id=fonograma.id) }}"
                    class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-arrow-left me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-warning btn-lg">
                    <i class="bi bi-check-lg me-2"></i>Salvar Alterações
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleSubdivisaoEdit() {
        var elFlag = document.getElementById('flag_nacional_edit');
        if (!elFlag) return;
        var flag = elFlag.value;
        var divSub = document.getElementById('div_subdivisao_edit');

        if (divSub) {
            if (flag === 'INTERNACIONAL') {
                divSub.style.display = '';
            } else {
                divSub.style.display = 'none';
            }
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        toggleSubdivisaoEdit();
        // Inicializar abas explicitamente
        var triggerTabList = [].slice.call(document.querySelectorAll('#participantesTab button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    });

    // --- FUNÇÕES PARA CAMPOS DINÂMICOS ---

    function criarBotaoRemover() {
        return '<button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.parentElement.remove()"><i class="bi bi-trash"></i></button>';
    }

    function adicionarAutor() {
        const container = document.getElementById('container-autores');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 border-bottom pb-2';
        div.innerHTML = `
            <div class="col-md-3">
                <label class="form-label small">Nome Completo</label>
                <input type="text" class="form-control form-control-sm" name="autores_nome[]" required placeholder="Nome do Autor">
            </div>
            <div class="col-md-2">
                <label class="form-label small">CPF</label>
                <input type="text" class="form-control form-control-sm" name="autores_cpf[]" placeholder="CPF (somente números)">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Função</label>
                <select class="form-select form-select-sm" name="autores_funcao[]">
                    <option value="AUTOR">Autor</option>
                    <option value="COMPOSITOR">Compositor</option>
                    <option value="VERSIONISTA">Versionista</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label small">%</label>
                <input type="text" class="form-control form-control-sm" name="autores_percentual[]" placeholder="100">
            </div>
            <div class="col-md-2">
                <label class="form-label small">CAE/IPI</label>
                <input type="text" class="form-control form-control-sm" name="autores_cae[]">
            </div>
             <div class="col-md-1">
                <label class="form-label small"></label>
                ${criarBotaoRemover()}
            </div>
        `;
        container.appendChild(div);
    }

    function adicionarInterprete() {
        const container = document.getElementById('container-interpretes');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 border-bottom pb-2';
        div.innerHTML = `
            <div class="col-md-3">
                <label class="form-label small">Nome Artístico/Civil</label>
                <input type="text" class="form-control form-control-sm" name="interpretes_nome[]" required placeholder="Nome do Intérprete">
            </div>
             <div class="col-md-2">
                <label class="form-label small">CPF/CNPJ</label>
                <input type="text" class="form-control form-control-sm" name="interpretes_doc[]">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Categoria</label>
                <select class="form-select form-select-sm" name="interpretes_categoria[]">
                    <option value="INTERPRETE">Intérprete</option>
                    <option value="MUSICO">Músico</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label small">%</label>
                <input type="text" class="form-control form-control-sm" name="interpretes_percentual[]" placeholder="100">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Associação</label>
                <select class="form-select form-select-sm" name="interpretes_assoc[]">
                    <option value="">Selecione...</option>
                    <option value="ABRAMUS">ABRAMUS</option>
                    <option value="UBC">UBC</option>
                    <option value="AMAR">AMAR</option>
                    <option value="SBACEM">SBACEM</option>
                    <option value="SICAM">SICAM</option>
                    <option value="SOCINPRO">SOCINPRO</option>
                </select>
            </div>
             <div class="col-md-1">
                <label class="form-label small"></label>
                ${criarBotaoRemover()}
            </div>
        `;
        container.appendChild(div);
    }

    function adicionarMusico() {
        const container = document.getElementById('container-musicos');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 border-bottom pb-2';
        div.innerHTML = `
            <div class="col-md-3">
                <label class="form-label small">Nome</label>
                <input type="text" class="form-control form-control-sm" name="musicos_nome[]" required placeholder="Nome do Músico">
            </div>
            <div class="col-md-3">
                <label class="form-label small">CPF</label>
                <input type="text" class="form-control form-control-sm" name="musicos_cpf[]">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Instrumento</label>
                <input type="text" class="form-control form-control-sm" name="musicos_instrumento[]" placeholder="Ex: Baixo">
            </div>
             <div class="col-md-2">
                <label class="form-label small">Tipo</label>
                <select class="form-select form-select-sm" name="musicos_tipo[]">
                    <option value="ACOMPANHANTE">Acompanhante</option>
                    <option value="SOLISTA">Solista</option>
                    <option value="ARRANJADOR">Arranjador</option>
                </select>
            </div>
             <div class="col-md-1">
                <label class="form-label small"></label>
                ${criarBotaoRemover()}
            </div>
        `;
        container.appendChild(div);
    }
</script>
{% endblock %}