{% extends "base.html" %}

{% block header_title %}Estat√≠sticas do Sistema{% endblock %}

{% block content %}
<section class="stats-page">
    <div class="stats-header">
        <h2>Status e Estat√≠sticas do Sistema</h2>
        <button class="btn-refresh" id="btnRefresh" onclick="carregarDados()">
            üîÑ Atualizar
        </button>
    </div>

    <!-- Health Check -->
    <div class="stats-section">
        <h3 class="section-title-health">Status do Sistema</h3>
        <div class="health-card" id="healthCard">
            <div class="loading">Carregando...</div>
        </div>
    </div>

    <!-- Estat√≠sticas Gerais -->
    <div class="stats-section">
        <h3 class="section-title-stats">Estat√≠sticas Gerais</h3>
        <div class="stats-grid-large" id="statsGrid">
            <div class="loading">Carregando...</div>
        </div>
    </div>

    <!-- Estat√≠sticas por Situa√ß√£o -->
    <div class="stats-section">
        <h3 class="section-title-situacao">Fonogramas por Situa√ß√£o</h3>
        <div class="situacao-grid" id="situacaoGrid">
            <div class="loading">Carregando...</div>
        </div>
    </div>

    <!-- Estat√≠sticas por G√™nero -->
    <div class="stats-section">
        <h3 class="section-title-genero">Top 10 G√™neros</h3>
        <div class="genero-list" id="generoList">
            <div class="loading">Carregando...</div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval = null;

function carregarDados() {
    carregarHealth();
    carregarEstatisticas();
}

function carregarHealth() {
    const healthCard = document.getElementById('healthCard');
    healthCard.innerHTML = '<div class="loading">Carregando...</div>';
    
    fetch('/api/health')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const health = data.data;
                healthCard.innerHTML = `
                    <div class="health-item">
                        <div class="health-icon status-ok">‚úì</div>
                        <div class="health-info">
                            <div class="health-label">Status</div>
                            <div class="health-value">${health.status || 'OK'}</div>
                        </div>
                    </div>
                    <div class="health-item">
                        <div class="health-icon">‚Ñπ</div>
                        <div class="health-info">
                            <div class="health-label">Vers√£o</div>
                            <div class="health-value">${health.version || '1.0'}</div>
                        </div>
                    </div>
                    <div class="health-item">
                        <div class="health-icon">üîß</div>
                        <div class="health-info">
                            <div class="health-label">Servi√ßo</div>
                            <div class="health-value">${health.service || 'Fonogramas ECAD/ABRAMUS'}</div>
                        </div>
                    </div>
                    <div class="health-item">
                        <div class="health-icon">üïê</div>
                        <div class="health-info">
                            <div class="health-label">√öltima Atualiza√ß√£o</div>
                            <div class="health-value">${new Date(data.timestamp).toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                `;
            } else {
                healthCard.innerHTML = '<div class="error">Erro ao carregar status</div>';
            }
        })
        .catch(err => {
            healthCard.innerHTML = `<div class="error">Erro: ${err.message}</div>`;
        });
}

function carregarEstatisticas() {
    const statsGrid = document.getElementById('statsGrid');
    const situacaoGrid = document.getElementById('situacaoGrid');
    const generoList = document.getElementById('generoList');
    
    statsGrid.innerHTML = '<div class="loading">Carregando...</div>';
    situacaoGrid.innerHTML = '<div class="loading">Carregando...</div>';
    generoList.innerHTML = '<div class="loading">Carregando...</div>';
    
    fetch('/api/v1/stats')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const stats = data.data;
                
                // Estat√≠sticas Gerais
                statsGrid.innerHTML = `
                    <div class="stat-card-large">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value-large">${stats.total_fonogramas || 0}</div>
                        <div class="stat-label-large">Total de Fonogramas</div>
                    </div>
                    <div class="stat-card-large">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-value-large">${stats.ultimos_30_dias || 0}</div>
                        <div class="stat-label-large">√öltimos 30 Dias</div>
                    </div>
                `;
                
                // Por Situa√ß√£o
                const situacoes = stats.por_situacao || {};
                situacaoGrid.innerHTML = Object.entries(situacoes).map(([situacao, count]) => {
                    const porcentagem = stats.total_fonogramas > 0 
                        ? ((count / stats.total_fonogramas) * 100).toFixed(1) 
                        : 0;
                    return `
                        <div class="situacao-card situacao-${situacao.toLowerCase()}">
                            <div class="situacao-name">${situacao}</div>
                            <div class="situacao-value">${count}</div>
                            <div class="situacao-porcentagem">${porcentagem}%</div>
                        </div>
                    `;
                }).join('');
                
                // Por G√™nero
                const generos = stats.por_genero || {};
                generoList.innerHTML = Object.entries(generos)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([genero, count], index) => {
                        const porcentagem = stats.total_fonogramas > 0 
                            ? ((count / stats.total_fonogramas) * 100).toFixed(1) 
                            : 0;
                        return `
                            <div class="genero-item">
                                <div class="genero-rank">#${index + 1}</div>
                                <div class="genero-name">${genero}</div>
                                <div class="genero-bar-container">
                                    <div class="genero-bar" style="width: ${porcentagem}%"></div>
                                </div>
                                <div class="genero-value">${count} (${porcentagem}%)</div>
                            </div>
                        `;
                    }).join('') || '<div class="empty">Nenhum dado dispon√≠vel</div>';
            } else {
                statsGrid.innerHTML = '<div class="error">Erro ao carregar estat√≠sticas</div>';
            }
        })
        .catch(err => {
            statsGrid.innerHTML = `<div class="error">Erro: ${err.message}</div>`;
        });
}

// Carregar ao iniciar
carregarDados();

// Auto-refresh a cada 30 segundos
autoRefreshInterval = setInterval(carregarDados, 30000);

// Limpar intervalo ao sair da p√°gina
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}



