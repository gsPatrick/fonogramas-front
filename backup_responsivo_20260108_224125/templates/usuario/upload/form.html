{% extends "usuario/base_usuario.html" %}

{% block page_title %}Conversor e Validador de Fonogramas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
    /* Ajustes para o contexto do dashboard */
    .upload-section,
    .info-section,
    .results-section {
        margin-bottom: 2rem;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .info-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .info-card h3 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: var(--cor-primaria);
    }

    .upload-area {
        border: 2px dashed #ccc;
        padding: 3rem;
        text-align: center;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-area:hover,
    .upload-area.dragover {
        border-color: var(--cor-primaria);
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block usuario_content %}
<!-- Informações do Sistema -->
<section class="info-section">
    <div class="info-card">
        <h3>Sobre o Conversor</h3>
        <p>Esta ferramenta processa arquivos CSV, valida regras de negócio (CPF, CNPJ, ISRC, Percentuais) e gera o Excel
            padrão ECAD prontinho para envio.</p>
    </div>
    <div class="info-card">
        <h3>Como usar</h3>
        <ol class="ps-3">
            <li>Baixe o template abaixo.</li>
            <li>Preencha com seus dados separando autores com pipe (|).</li>
            <li>Suba o arquivo e aguarde a validação.</li>
            <li>Baixe o Excel gerado ou salve no sistema.</li>
        </ol>
    </div>
    <div class="info-card">
        <h3>Template</h3>
        <p>Use nosso modelo para garantir a formatação correta.</p>
        <a href="{{ url_for('usuario.download_template') }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-download"></i> Baixar Modelo CSV/Excel
        </a>
    </div>
</section>

<!-- Área de Upload -->
<section class="upload-section">
    <div class="upload-area" id="uploadArea">
        <div class="upload-content">
            <i class="bi bi-cloud-arrow-up text-primary" style="font-size: 3rem;"></i>
            <h3 class="mt-3">Arraste e solte seu arquivo CSV aqui</h3>
            <p class="text-muted">ou clique para selecionar do computador</p>
            <input type="file" id="fileInput" accept=".csv" hidden>
        </div>
    </div>
    <div class="file-info mt-3 align-items-center justify-content-center" id="fileInfo"
        style="display: none; gap: 10px;">
        <span id="fileName" class="fw-bold"></span>
        <button class="btn btn-sm btn-outline-danger rounded-circle" id="btnRemove" title="Remover arquivo"
            style="width: 30px; height: 30px; padding: 0;">×</button>
    </div>
</section>

<!-- Botão Processar -->
<section class="actions-section text-center mb-4">
    <button class="btn btn-primary btn-lg px-5" id="btnProcessar" disabled>
        <span class="btn-text"><i class="bi bi-gear-fill me-2"></i>Processar e Validar</span>
        <span class="btn-loader" style="display: none;">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Processando...
        </span>
    </button>
</section>

<!-- Barra de Progresso -->
<section class="progress-section mb-4" id="progressSection" style="display: none;">
    <div class="progress" style="height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressFill" role="progressbar"
            style="width: 0%"></div>
    </div>
    <p class="text-center mt-2 text-muted" id="progressText">Iniciando...</p>
</section>

<!-- Relatório de Resultados -->
<section class="results-section" id="resultsSection" style="display: none;">
    <div class="results-header item-align-center mb-4">
        <h2 class="h4">Relatório de Processamento</h2>
        <p class="text-muted">Resumo da análise do seu arquivo</p>
    </div>

    <div class="row g-3 text-center mb-4">
        <div class="col-md-3">
            <div class="p-3 border rounded bg-light">
                <div class="display-6 fw-bold" id="statTotal">0</div>
                <div class="text-muted small">Total de Linhas</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 border rounded bg-success text-white">
                <div class="display-6 fw-bold" id="statValidas">0</div>
                <div class="small">Linhas Válidas</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 border rounded bg-danger text-white">
                <div class="display-6 fw-bold" id="statErros">0</div>
                <div class="small">Linhas com Erro</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 border rounded bg-warning text-dark">
                <div class="display-6 fw-bold" id="statTotalErros">0</div>
                <div class="small">Total de Erros</div>
            </div>
        </div>
    </div>

    <!-- Seção de Erros -->
    <div class="errors-section mb-4" id="errorsSection" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h5 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Erros Encontrados</h3>
            <div>
                <button class="btn btn-sm btn-outline-secondary" id="btnExpandAll">Expandir Todos</button>
                <button class="btn btn-sm btn-outline-secondary" id="btnCollapseAll">Recolher Todos</button>
            </div>
        </div>

        <div class="errors-grouped" id="errorsGrouped"></div>

        <div class="errors-more text-center mt-3" id="errorsMore" style="display: none;">
            <button class="btn btn-secondary btn-sm" id="btnShowMore">Mostrar mais erros</button>
            <span id="errorsRemaining" class="text-muted ms-2"></span>
        </div>
    </div>

    <!-- Ações Finais -->
    <div class="download-section text-center p-4 border-top">
        <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-success btn-lg" id="btnDownload" style="display: none;">
                <i class="bi bi-file-earmark-excel-fill me-2"></i> Baixar Excel Convertido
            </button>

            <!-- Formulário invisível para salvar no banco -->
            <form action="{{ url_for('usuario.salvar_upload') }}" method="POST" id="formSalvarNoBanco"
                style="display: inline;">
                <input type="hidden" name="salvar_apenas_validos" value="on">
                <button type="submit" class="btn btn-primary btn-lg" id="btnSalvarSistema" style="display: none;">
                    <i class="bi bi-database-add me-2"></i> Salvar no meu Dashboard
                </button>
            </form>
        </div>
        <p class="download-note mt-2 text-muted small">
            O arquivo Excel já vem formatado nas cores e padrões exigidos pelo ECAD/ABRAMUS.
            <br>Ao clicar em "Salvar no meu Dashboard", os fonogramas válidos serão importados para sua conta.
        </p>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
    // Sobrescrever comportamento do download para mostrar botão de salvar também
    const originalExibirResultados = window.exibirResultados;

    // Pequeno hack para integrar o botão de salvar que não existia no script.js original
    // Monitorar a exibição da resultsSection
    const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (document.getElementById('resultsSection').style.display !== 'none') {
                // Se tem linhas válidas > 0, mostrar botão de salvar
                const validas = parseInt(document.getElementById('statValidas').textContent || '0');
                const btnSalvar = document.getElementById('btnSalvarSistema');
                if (btnSalvar) {
                    btnSalvar.style.display = validas > 0 ? 'inline-block' : 'none';
                }
            }
        });
    });

    const target = document.getElementById('resultsSection');
    if (target) {
        observer.observe(target, { attributes: true, attributeFilter: ['style'] });
    }
</script>
{% endblock %}